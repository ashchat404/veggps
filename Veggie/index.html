<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foundation</title>
    <link rel="stylesheet" href="stylesheets/app.css" />
    <script src="bower_components/modernizr/modernizr.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDnB1c46S08wnHCFLQBQX-tmHS1mq1tc9E&libraries=places&sensor=false"></script>
    <script type="text/javascript">
 //<![CDATA[
var map;
var infowindow;
function initialize() {
    var mapOptions = {
      zoom: 15,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    map = new google.maps.Map(document.getElementById('map-canvas'),
    mapOptions);

    // Try HTML5 geolocation
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var pos = new google.maps.LatLng(position.coords.latitude,
          position.coords.longitude);

          infowindow = new google.maps.InfoWindow({
          map: map,
          position: pos,
          });
          var marker = new google.maps.Marker({
          map: map,
          position: pos,
          icon : "img/map_icon.png"
          });
          infowindow.setContent('<h5 style="margin:10px">Your location :)</h5>');

          var request = {
          location: pos,
          radius: 500,
          types: ['food']
          }; 

          service = new google.maps.places.PlacesService(map);
          service.nearbySearch(request, callback);

          //console.log(pos);

          map.setCenter(pos);
        }, function() {
        handleNoGeolocation(true);
        });

    }
    else {
      // Browser doesn't support Geolocation
      handleNoGeolocation(false);
    }

 var array = [];

    function callback(results, status) {
      $("#details").empty();
      if (status == google.maps.places.PlacesServiceStatus.OK) {
        downloadUrl("php_to_xml.php",function(data){
          var xml = data.responseXML;
          var markers = xml.documentElement.getElementsByTagName("resdetails");
          var detail = xml.documentElement.getElementsByTagName("detail1");

          for (r = 0; r < detail.length; r++){
              var maindetail = detail[r].childNodes[0].getAttribute('name');
              var mainid = detail[r].childNodes[0].getAttribute('id');

              var dishes=[];
              for (j = 1; j<detail[r].childNodes.length;j++){  // start at 1 because 0 should be resdetails
                  var info = detail[r].childNodes[j].getAttributeNode('dishname');
                  if (info != null){
                      dishes.push(info.nodeValue); 
                  }
              }
              array.push([mainid,maindetail,dishes]);  
          }

          for (var i = 0; i < results.length; i++){
            var place = results[i];
            console.log(results[i].id + " " + results[i].name);
            for (d = 0;d < array.length; d++){
             // console.log(d + "=" + array[d]);
                if (place.id == array[d][0]){
                  createMarker(results[i]);
                  //console.log('matched');                                   
                }
            }
          }

        });
      }
    }


    function createMarker(place) {
      var placeLoc = place.geometry.location;
           var contentString = 
           '<div id="content">'+
                '<h1 id="firstHeading" class="firstHeading">'+place.name+'</h1>'+
                '<h5>'+place.vicinity+'</h5>'+
                '<h3>'+array[d][2]+'</h3>'+
                '<div id="bodyContent">'+

                '</div>'+
            '</div>';


      var marker = new google.maps.Marker({
        map: map,
        content: contentString,
        position: place.geometry.location
      });

      google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent(contentString);
        infowindow.open(map, this);
      });

    }
}

    function downloadUrl(url, callback) {
      var request = window.ActiveXObject ?
      new ActiveXObject('Microsoft.XMLHTTP') :
      new XMLHttpRequest;

      request.onreadystatechange = function() {
      if (request.readyState == 4) {
        request.onreadystatechange = doNothing;
        callback(request, request.status);
      }
    };
    
    function doNothing() {}
      request.open('GET', url, true);
      request.send(null);
    }
    
    function handleNoGeolocation(errorFlag) {
      if (errorFlag) {
        var content = 'Error: The Geolocation service failed.';
      } else {
        var content = 'Error: Your browser doesn\'t support geolocation.';
      }

      var options = {
        map: map,
        position: new google.maps.LatLng(60, 105),
        content: content
      };

      var infowindow = new google.maps.InfoWindow(options);
      map.setCenter(options.position);
    }
  
  //]]>
google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
      <section>
        <div class="content">
          <h1>VEGGIE GPS</h1>
          <nav>
            <ul>
              <li><a href="#">About Us</a></li>
              <li><a href="form.html">Signup</a></li>
            </ul>
          </nav>
        </div>
        <div id="map-canvas"></div>
       <!-- <div id="details"></div>-->
      </section>


    <script src="bower_components/jquery/jquery.js"></script>
    <script src="bower_components/foundation/js/foundation.min.js"></script>
    <script src="js/app.js"></script>
  </body>
</html>
